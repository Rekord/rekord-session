/* rekord-session 1.4.1 - Adds mass changes & discards to Rekord by Philip Diffenderfer */
!function(t,e,s){function i(){this.status=i.Status.Active,this.watching=new r,this.removing=new r,this.unwatched=new r,this.validationRequired=!1}function n(t,e){this.key=t,this.object=e,this.state=null,this.relations=!1,this.parent=!1,this.children={},this.offs=[],this.save=!1,this.cascade=s,this.state=null}function a(t,e,i,n){for(var a=t.values,o=a.length-1;o>=0;o--){var r=a[o],h=i.call(n,r.object,r);if(h!==s)return h}return e}function o(t,e,i,n){for(var a=t.values,o=a.length-1;o>=0;o--){var r=a[o];if(r.object instanceof h){var c=i.call(n,r.object,r);if(c!==s)return c}}return e}var r=e.Map,h=e.Model,c=e.Promise,u=e.Database,d=e.Collection,v=e.ModelCollection,l=e.Relations.hasOne,f=e.Relations.belongsTo,g=e.Cascade,m=e.isObject,y=e.isNumber,S=e.uuid,w=e.equals,$=e.noop,R=e.addMethods,p=e.replaceMethod,b=e.createParser("$key()"),C={RelationUpdate:function(t,e,s,i,n){return function(s,i){t.isDestroyed()||(i.lastRelated&&t.isWatching(i.lastRelated)&&t.unwatch(i.lastRelated),i.related&&!t.isWatching(i.related)&&t.watch(i.related,e.relations[n],e))}},CollectionAdd:function(t,e){return function(s,i){t.isDestroyed()||t.watch(i,e.relations,e)}},CollectionAdds:function(t,e){return function(s,i){if(!t.isDestroyed())for(var n=0;n<i.length;n++)t.watch(i[n],e.relations,e)}},CollectionRemove:function(t,e){return function(e,s){t.isDestroyed()||t.unwatch(s)}},CollectionRemoves:function(t,e){return function(e,s){if(!t.isDestroyed())for(var i=0;i<s.length;i++)t.unwatch(s[i])}},CollectionReset:function(t,e){return function(s){if(!t.isDestroyed()){e.moveChildren(t.unwatched);for(var i=0;i<s.length;i++)t.watch(s[i],e.relations,e)}}},CollectionCleared:function(t,e){return function(s){t.isDestroyed()||e.moveChildren(t.unwatched)}}};p(h.prototype,"$save",function(t){return function(s,i,n){var a=this.$session&&this.$session.isActive();if(this.$isDeleted())return e.debug(e.Debugs.SAVE_DELETED,this.$db,this),c.resolve(this);if(a){var n=3===arguments.length?n:2===arguments.length&&m(s)&&y(i)?i:1===arguments.length&&y(s)?s:this.$db.cascade;return this.$set(s,i),this.$session.saveModel(this,n),c.resolve(this)}return t.apply(this,arguments)}}),p(h.prototype,"$remove",function(t){return function(e){var s=this.$session&&this.$session.isSaving(),i=this.$session&&this.$session.isActive();return this.$exists()||s?i?(this.$session.removeModel(this,e),c.resolve(this)):t.apply(this,arguments):c.resolve(this)}}),i.Status={Active:"active",Saving:"saving",Disabled:"disabled",Destroyed:"destroyed"},R(i.prototype,{hasChanges:function(t){if(this.removing.size()>0)return!0;var e=o(this.unwatched,!1,function(e,s){return t&&!s.save||!e.$hasChanges()?void 0:!0});if(e)return!0;var s=o(this.watching,!1,function(e,s){return t&&!s.save||!e.$hasChanges()?void 0:!0});return s},getChanged:function(t,e){var s=e||new d;return s.push.apply(s,this.removing.values),o(this.watching,null,function(e,i){t&&!i.save||!e.$hasChanges()||s.push(e)}),o(this.unwatched,null,function(e,i){t&&!i.save||!e.$hasChanges()||s.push(e)}),s},validate:function(t){var s=!0;return e.Validation&&o(this.watching,!0,function(e,i){return e.$validate&&!e.$validate()&&(s=!1,t)?!1:void 0}),s},setValidationRequired:function(t){this.validationRequired=t},save:function(t){if(this.status!==i.Status.Active)return c.reject(this);if(this.validationRequired&&!this.validate(!t))return c.reject(this);var e=new c,s=c.singularity(e,this,this.handleSave);return e.resolve(this),s.success(this.onSaveSuccess,this),s},handleSave:function(t){this.status=i.Status.Saving,o(this.watching,!0,this.executeSave,this),o(this.removing,!0,this.executeRemove,this),a(this.unwatched,!0,this.executeUnwatchedSave,this),this.status=i.Status.Active},executeSave:function(t,e){e.save&&(t.$isSaved()||t.$db.models.remove(t.$key()),t.$save(e.cascade).success(this.afterSave(e)))},executeRemove:function(t,e){t.$status===h.Status.RemovePending&&(t.$status=h.Status.Synced,t.$db.models.put(t.$key(),t),t.$remove(e.cascade).success(this.afterRemove(e,this)))},executeUnwatchedSave:function(t,e){e.save&&(t.$isSaved()||t.$db.models.remove(t.$key()),t.$save(e.cascade).success(this.afterUnwatchSave(e)))},afterSave:function(t){return function(){t.saveState(!0),t.save=!1}},afterRemove:function(t,e){return function(){e.removing.remove(t.key),t.destroyReferences()}},afterUnwatchSave:function(t){return function(){t.destroy()}},onSaveSuccess:function(){a(this.unwatched,!0,this.onSaveSuccessUnwatched,this),this.removing.reset(),this.unwatched.reset()},onSaveSuccessUnwatched:function(t,e){e.destroy()},discard:function(){return o(this.removing,!0,this.discardRemove,this),a(this.unwatched,!0,this.discardUnwatched,this),o(this.watching,!0,this.discardSave,this),this.removing.reset(),this.unwatched.reset(),this},discardSave:function(t,e){e.save&&(e.save=!1,t.$isSaved()||t.$db.removeFromModels(t)),e.restoreState(),t.$updated()},discardRemove:function(t,e){t.$status===h.Status.RemovePending&&(t.$status=h.Status.Synced,t.$db.models.put(t.$key(),t),e.reattach())},discardUnwatched:function(t,e){e.reattach()},disable:function(){this.status===i.Status.Active&&(this.status=i.Status.Disabled)},enable:function(){this.status===i.Status.Disabled&&(this.status=i.Status.Active)},isEnabled:function(){return this.status!==i.Status.Disabled&&this.status!==i.Status.Destroyed},isActive:function(){return this.status===i.Status.Active},isDisabled:function(){return this.status===i.Status.Disabled},isSaving:function(){return this.status===i.Status.Saving},isDestroyed:function(){return this.status===i.Status.Destroyed},destroy:function(){if(this.status!==i.Status.Destroyed){for(var t=this.watching.values,e=0;e<t.length;e++){var s=t[e];s.parent||s.destroy()}for(var n=this.removing.values,e=0;e<n.length;e++){var a=n[e];a.destroyReferences()}this.watching.reset(),this.removing.reset(),this.status=i.Status.Destroyed}},getSessionKey:function(t,e){if(t instanceof h)return t.$uid();if(t instanceof v)return!t.$sessionKey&&e&&(t.$sessionKey=S()),t.$sessionKey;if(e)throw"The object provided cannot be watched by session."},getSessionWatch:function(t,e){var s=this.getSessionKey(t,e);if(s){var i=this.watching.get(s);return!i&&e&&(i=this.unwatched.get(s),this.unwatched.remove(s),i&&this.watching.put(s,i)),!i&&e&&(i=new n(s,t),this.watching.put(s,i)),i}},getAnyWatch:function(t){var e=this.getSessionKey(t),s=null;return e&&(s=this.watching.get(e),s||(s=this.unwatched.get(e))),s},getRemoveWatch:function(t){var e=this.getSessionKey(t);return e?this.removing.get(e):void 0},isWatching:function(t){var e=this.getSessionKey(t);return e&&this.watching.has(e)},isUnwatched:function(t){var e=this.getSessionKey(t);return e&&this.unwatched.has(e)},isRemoved:function(t){var e=this.getSessionKey(t);return e&&this.removing.has(e)},hasWatched:function(t){var e=this.getSessionKey(t);return e&&(this.watching.has(e)||this.removing.has(e)||this.unwatched.has(e))},watchMany:function(t,e){for(var s=[],i=0;i<t.length;i++)s.push(this.watch(t[i],e));return s},watch:function(t,e,s){var i=this.getSessionWatch(t,!0);if(i.setRelations(e),i.setSession(this),i.setParent(s),i.saveState(),m(e))for(var n in e){var a=t[n];a instanceof h?this.watch(a,e[n],i):a instanceof v&&this.watchCollection(a,e[n],i);var o=t.$getRelation(n);(o instanceof l||o instanceof f)&&i.addListener(h.Events.RelationUpdate,C.RelationUpdate(this,i,t,a,n))}return i},watchCollection:function(t,e,s){var i=this.getSessionWatch(t,!0);return i.setRelations(e),i.setSession(this),i.setParent(s),t.each(function(t){this.watch(t,e,i)},this),i.addListener(d.Events.Add,C.CollectionAdd(this,i)),i.addListener(d.Events.Adds,C.CollectionAdds(this,i)),i.addListener(d.Events.Reset,C.CollectionReset(this,i)),i.addListener(d.Events.Remove,C.CollectionRemove(this,i)),i.addListener(d.Events.Removes,C.CollectionRemoves(this,i)),i.addListener(d.Events.Cleared,C.CollectionCleared(this,i)),i},unwatch:function(t){if(t){var e=this.getSessionWatch(t);e&&e.moveTo(this.unwatched)}},saveModel:function(t,e){var s=this.getAnyWatch(t);if(s&&(s.addCascade(e),!s.save)){var i=t.$key(),n=t.$db;n.models.has(i)?(n.trigger(u.Events.ModelUpdated,[t]),t.$trigger(h.Events.UpdateAndSave)):(n.models.put(i,t),n.trigger(u.Events.ModelAdded,[t]),n.updated(),t.$trigger(h.Events.CreateAndSave)),s.save=!0}},removeModel:function(t,e){var s=this.getAnyWatch(t);if(s)s.addCascade(e),s.moveTo(this.removing),t.$status=h.Status.RemovePending,t.$db.removeFromModels(t);else{var i=this.getRemoveWatch(t);i&&i.addCascade(e)}}}),R(n.prototype,{setRelations:function(t){if(m(t)){if(this.relations&&!w(this.relations,t))throw"Changing already watched relations is not allowed.";this.relations=t}},setSession:function(t){var e=this.object,s=e.$session;if(s&&s!==t&&!s.isDestroyed())throw"An object can only be watched by one live session at a time.";e.$session=t},setParent:function(t){this.parent=t,t&&(t.children[this.key]=this)},addListener:function(t,e){var s=this.object,i=$;s.$on?i=s.$on(t,e):s.on&&(i=s.on(t,e)),this.offs.push(i)},addCascade:function(t){y(t)&&(this.cascade===s&&(this.cascade=0),this.cascade=this.cascade|t)},saveState:function(t){if(!this.state||t){var e=this.object,s=e.$savedState;e.$push();var i=this.relations,n=e.$savedState;if(m(i))for(var a in i){var o=e[a];o instanceof h?n[a]=o.$key():o instanceof v?n[a]=o.pluck(b):n[a]=null}this.state=n,e.$savedState=s}},restoreState:function(){var t=this.object,e=this.state;if(m(e)){var i=t.$db.relations,n=this.relations,a={};for(var o in n){var r=i[o];a[o]={clearKey:r.clearKey,cascadeRemove:r.cascadeRemove,cascade:r.cascade},r.clearKey=!1,r.cascadeRemove=g.None,r.cascade=g.None}t.$set(e,s,!0,!0),t.$decode();for(var o in n){var r=i[o],h=a[o];r.clearKey=h.clearKey,r.cascadeRemove=h.cascadeRemove,r.cascade=h.cascade}}},removeListeners:function(){for(var t=this.offs,e=0;e<t.length;e++)t[e]();t.length=0},moveTo:function(t){var e=this.object.$session;this.removeListeners(),this.moveChildren(t),this.parent&&delete this.parent.children[this.key],e.watching.remove(this.key),e.unwatched.remove(this.key),e.removing.remove(this.key),t.put(this.key,this)},reattach:function(){var t=this.object.$session;t.removing.remove(this.key),t.unwatched.remove(this.key),t.watching.put(this.key,this),t.watch(this.object,this.relations,this.parent)},destroy:function(){var t=this.children;this.children={},this.removeListeners(),this.destroyReferences();for(var e in t)t[e].destroy()},destroyReferences:function(){var t=this.object.$session;t.watching.remove(this.key),t.removing.remove(this.key),t.unwatched.remove(this.key),this.object.$session=null,this.state=null,this.parent=null,this.save=!1,this.cascade=s},moveChildren:function(t){var e=this.children;for(var s in e)e[s].moveTo(t)}}),e.Session=i,e.SessionWatch=n}(this,this.Rekord);
//# sourceMappingURL=rekord-session.min.js.map
