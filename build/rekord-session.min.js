/* rekord-session 1.4.5 - Adds mass changes & discards to Rekord by Philip Diffenderfer */
!function(e,t){"function"==typeof define&&define.amd?define(["rekord"],function(s){return t(e,s)}):"object"==typeof module&&module.exports?module.exports=t(global,require("rekord")):e.Rekord=t(e,e.Rekord)}(this,function(e,t,s){function i(){this.status=i.Status.Active,this.watching=new o,this.removing=new o,this.unwatched=new o,this.validationRequired=!1,this.promise=c.resolve(this)}function n(e,t){this.key=e,this.object=t,this.state=null,this.relations=!1,this.parent=!1,this.children={},this.offs=[],this.save=!1,this.cascade=s,this.state=null}function a(e,t,i,n){for(var a=e.values,r=a.length-1;r>=0;r--){var o=a[r],h=i.call(n,o.object,o);if(h!==s)return h}return t}function r(e,t,i,n){for(var a=e.values,r=a.length-1;r>=0;r--){var o=a[r];if(o.object instanceof h){var c=i.call(n,o.object,o);if(c!==s)return c}}return t}var o=t.Map,h=t.Model,c=t.Promise,u=t.Database,d=t.Collection,v=t.ModelCollection,l=t.Relations.hasOne,f=t.Relations.belongsTo,g=t.Cascade,S=t.isObject,m=t.isNumber,y=t.uuid,w=t.equals,$=t.noop,p=t.addMethods,b=t.replaceMethod,R=t.addEventful,C=t.addEventFunction,D=t.createParser("$key()"),E={RelationUpdate:function(e,t,s,i,n){return function(s,i){e.isDestroyed()||(i.lastRelated&&e.isWatching(i.lastRelated)&&e.unwatch(i.lastRelated),i.related&&!e.isWatching(i.related)&&e.watch(i.related,t.relations[n],t))}},CollectionAdd:function(e,t){return function(s,i){e.isDestroyed()||e.watch(i,t.relations,t)}},CollectionAdds:function(e,t){return function(s,i){if(!e.isDestroyed())for(var n=0;n<i.length;n++)e.watch(i[n],t.relations,t)}},CollectionRemove:function(e,t){return function(t,s){e.isDestroyed()||e.unwatch(s)}},CollectionRemoves:function(e,t){return function(t,s){if(!e.isDestroyed())for(var i=0;i<s.length;i++)e.unwatch(s[i])}},CollectionReset:function(e,t){return function(s){if(!e.isDestroyed()){t.moveChildren(e.unwatched);for(var i=0;i<s.length;i++)e.watch(s[i],t.relations,t)}}},CollectionCleared:function(e,t){return function(s){e.isDestroyed()||t.moveChildren(e.unwatched)}}};return b(h.prototype,"$save",function(e){return function(s,i,n){var a=this.$session&&this.$session.isActive();if(this.$isDeleted())return t.debug(t.Debugs.SAVE_DELETED,this.$db,this),c.resolve(this);if(a){var n=3===arguments.length?n:2===arguments.length&&S(s)&&m(i)?i:1===arguments.length&&m(s)?s:this.$db.cascade;return this.$set(s,i),this.$session.saveModel(this,n),c.resolve(this)}return e.apply(this,arguments)}}),b(h.prototype,"$remove",function(e){return function(t){var s=this.$session&&this.$session.isSaving(),i=this.$session&&this.$session.isActive();return this.$exists()||s?i?(this.$session.removeModel(this,t),c.resolve(this)):e.apply(this,arguments):c.resolve(this)}}),i.Status={Active:"active",Saving:"saving",Disabled:"disabled",Destroyed:"destroyed"},i.Events={Discard:"discard",SaveStart:"save-start",SaveSuccess:"save-sucess",SaveFailure:"save-failure",Destroy:"destroy",Watch:"watch",Unwatch:"unwatch",Invalid:"invalid",Valid:"valid",Changes:"discard save-start save-success save-failure destroy"},p(i.prototype,{hasChanges:function(e){if(this.removing.size()>0)return!0;var t=r(this.unwatched,!1,function(t,s){return e&&!s.save||!t.$hasChanges()?void 0:!0});if(t)return!0;var s=r(this.watching,!1,function(t,s){return e&&!s.save||!t.$hasChanges()?void 0:!0});return s},getChanged:function(e,t){var s=t||new d;return s.push.apply(s,this.removing.values),r(this.watching,null,function(t,i){e&&!i.save||!t.$hasChanges()||s.push(t)}),r(this.unwatched,null,function(t,i){e&&!i.save||!t.$hasChanges()||s.push(t)}),s},validate:function(e){var s=!0;return t.Validation&&(r(this.watching,!0,function(t,i){return t.$validate&&!t.$validate()&&(s=!1,e)?!1:void 0}),s?this.trigger(i.Events.Valid,[this]):this.trigger(i.Events.Invalid,[this])),s},setValidationRequired:function(e){this.validationRequired=e},save:function(e){if(this.status!==i.Status.Active)return c.reject(this);if(this.validationRequired&&!this.validate(!e))return c.reject(this);if(this.promise.isPending())return c.reject(this);this.trigger(i.Events.SaveStart,[this]);var t=new c,s=c.singularity(t,this,this.handleSave);return t.resolve(this),s.success(this.onSaveSuccess,this),s.complete(this.onSaveComplete,this),this.promise=s,s},handleSave:function(e){this.status=i.Status.Saving,r(this.watching,!0,this.executeSave,this),r(this.removing,!0,this.executeRemove,this),a(this.unwatched,!0,this.executeUnwatchedSave,this),this.status=i.Status.Active},executeSave:function(e,t){t.save&&(e.$isSaved()||e.$db.models.remove(e.$key()),e.$save(t.cascade).success(this.afterSave(t)))},executeRemove:function(e,t){e.$status===h.Status.RemovePending&&(this.resync(e),e.$remove(t.cascade).success(this.afterRemove(t,this)))},executeUnwatchedSave:function(e,t){t.save&&(e.$isSaved()||e.$db.models.remove(e.$key()),e.$save(t.cascade).success(this.afterUnwatchSave(t)))},afterSave:function(e){return function(){e.resetSave(),e.saveState(!0)}},afterRemove:function(e,t){return function(){t.removing.remove(e.key),e.destroyReferences()}},afterUnwatchSave:function(e){return function(){e.destroy()}},onSaveComplete:function(){this.promise.isSuccess()?this.trigger(i.Events.SaveSuccess,[this]):this.trigger(i.Events.SaveFailure,[this])},onSaveSuccess:function(){a(this.unwatched,!0,this.onSaveSuccessUnwatched,this),this.removing.reset(),this.unwatched.reset()},onSaveSuccessUnwatched:function(e,t){t.destroy()},discard:function(){return r(this.removing,!0,this.discardRemove,this),a(this.unwatched,!0,this.discardUnwatched,this),r(this.watching,!0,this.discardSave,this),this.removing.reset(),this.unwatched.reset(),this},discardSave:function(e,t){t.save&&!e.$isSaved()&&e.$db.removeFromModels(e),t.resetSave(),t.restoreState(),e.$updated()},discardRemove:function(e,t){e.$status===h.Status.RemovePending&&(this.resync(e),t.reattach())},discardUnwatched:function(e,t){t.reattach()},disable:function(){this.status===i.Status.Active&&(this.status=i.Status.Disabled)},enable:function(){this.status===i.Status.Disabled&&(this.status=i.Status.Active)},isEnabled:function(){return this.status!==i.Status.Disabled&&this.status!==i.Status.Destroyed},isActive:function(){return this.status===i.Status.Active},isDisabled:function(){return this.status===i.Status.Disabled},isSaving:function(){return this.status===i.Status.Saving},isDestroyed:function(){return this.status===i.Status.Destroyed},destroy:function(){if(this.status!==i.Status.Destroyed){for(var e=this.watching.values,t=0;t<e.length;t++){var s=e[t];s.parent||s.destroy()}for(var n=this.unwatched.values,t=0;t<n.length;t++){var s=n[t];s.parent||s.destroy()}for(var a=this.removing.values,t=0;t<a.length;t++){var r=a[t];r.destroyReferences()}this.watching.reset(),this.unwatched.reset(),this.removing.reset(),this.status=i.Status.Destroyed,this.trigger(i.Events.Destroy,[this])}},getSessionKey:function(e,t){if(e instanceof h)return e.$uid();if(e instanceof v)return!e.$sessionKey&&t&&(e.$sessionKey=y()),e.$sessionKey;if(t)throw"The object provided cannot be watched by session."},getSessionWatch:function(e,t){var s=this.getSessionKey(e,t);if(s){var i=this.watching.get(s);return!i&&t&&(i=this.unwatched.get(s),this.unwatched.remove(s),i&&this.watching.put(s,i)),!i&&t&&(i=new n(s,e),this.watching.put(s,i)),i}},getAnyWatch:function(e){var t=this.getSessionKey(e);return t?this.watching.get(t)||this.unwatched.get(t):void 0},getRemoveWatch:function(e){var t=this.getSessionKey(e);return t?this.removing.get(t):void 0},isWatching:function(e){var t=this.getSessionKey(e);return t&&this.watching.has(t)},isUnwatched:function(e){var t=this.getSessionKey(e);return t&&this.unwatched.has(t)},isRemoved:function(e){var t=this.getSessionKey(e);return t&&this.removing.has(t)},hasWatched:function(e){var t=this.getSessionKey(e);return t&&(this.watching.has(t)||this.removing.has(t)||this.unwatched.has(t))},watchMany:function(e,t){for(var s=[],i=0;i<e.length;i++)s.push(this.watch(e[i],t));return s},watch:function(e,t,s){var n=this.getSessionWatch(e,!0);if(n.setRelations(t),n.setSession(this),n.setParent(s),n.saveState(),S(t))for(var a in t){var r=e[a];r instanceof h?this.watch(r,t[a],n):r instanceof v&&this.watchCollection(r,t[a],n);var o=e.$getRelation(a);(o instanceof l||o instanceof f)&&n.addListener(h.Events.RelationUpdate,E.RelationUpdate(this,n,e,r,a))}return this.trigger(i.Events.Watch,[this,e,n]),n},watchCollection:function(e,t,s){var n=this.getSessionWatch(e,!0);return n.setRelations(t),n.setSession(this),n.setParent(s),e.each(function(e){this.watch(e,t,n)},this),n.addListener(d.Events.Add,E.CollectionAdd(this,n)),n.addListener(d.Events.Adds,E.CollectionAdds(this,n)),n.addListener(d.Events.Reset,E.CollectionReset(this,n)),n.addListener(d.Events.Remove,E.CollectionRemove(this,n)),n.addListener(d.Events.Removes,E.CollectionRemoves(this,n)),n.addListener(d.Events.Cleared,E.CollectionCleared(this,n)),this.trigger(i.Events.Watch,[this,e,n]),n},unwatch:function(e){if(e){var t=this.getSessionWatch(e);t&&(this.isDestroyable(e)?t.destroy():(t.resetSave(),t.moveTo(this.unwatched)),this.trigger(i.Events.Unwatch,[this,e,t]))}},saveModel:function(e,t){var s=this.getAnyWatch(e);if(s&&(s.addCascade(t),!s.save)){var i=e.$key(),n=e.$db;n.models.has(i)?(n.trigger(u.Events.ModelUpdated,[e]),e.$trigger(h.Events.UpdateAndSave)):(n.models.put(i,e),n.trigger(u.Events.ModelAdded,[e]),n.updated(),e.$trigger(h.Events.CreateAndSave)),s.save=!0}},removeModel:function(e,t){var s=this.getAnyWatch(e);if(s)this.isDestroyable(e)?s.destroy():(s.resetSave(),s.addCascade(t),s.moveTo(this.removing),e.$status=h.Status.RemovePending,e.$db.removeFromModels(e));else{var i=this.getRemoveWatch(e);i&&i.addCascade(t)}},isDestroyable:function(e){return e instanceof h&&!e.$isSaved()},resync:function(e){e.$status=h.Status.Synced,e.$db.models.put(e.$key(),e)}}),R(i.prototype),C(i.prototype,"change",i.Events.Changes),p(n.prototype,{setRelations:function(e){if(S(e)){if(this.relations&&!w(this.relations,e))throw"Changing already watched relations is not allowed.";this.relations=e}},setSession:function(e){var t=this.object,s=t.$session;if(s&&s!==e&&!s.isDestroyed())throw"An object can only be watched by one live session at a time.";t.$session=e},setParent:function(e){this.parent=e,e&&(e.children[this.key]=this)},addListener:function(e,t){var s=this.object,i=$;s.$on?i=s.$on(e,t):s.on&&(i=s.on(e,t)),this.offs.push(i)},addCascade:function(e){m(e)&&(this.cascade===s&&(this.cascade=0),this.cascade=this.cascade|e)},resetSave:function(){this.save=!1,this.cascade=s},saveState:function(e){if(!this.state||e){var t=this.object,s=t.$savedState;t.$push();var i=this.relations,n=t.$savedState;if(S(i))for(var a in i){var r=t[a];r instanceof h?n[a]=r.$key():r instanceof v?n[a]=r.pluck(D):n[a]=null}this.state=n,t.$savedState=s}},restoreState:function(){var e=this.object,t=this.state;if(S(t)){var i=e.$db.relations,n=this.relations,a={};for(var r in n){var o=i[r];a[r]={clearKey:o.clearKey,cascadeRemove:o.cascadeRemove,cascade:o.cascade},o.clearKey=!1,o.cascadeRemove=g.None,o.cascade=g.None}e.$set(t,s,!0,!0),e.$decode();for(var r in n){var o=i[r],h=a[r];o.clearKey=h.clearKey,o.cascadeRemove=h.cascadeRemove,o.cascade=h.cascade}}},removeListeners:function(){for(var e=this.offs,t=0;t<e.length;t++)e[t]();e.length=0},moveTo:function(e){var t=this.object.$session;this.removeListeners(),this.moveChildren(e),this.parent&&delete this.parent.children[this.key],t.watching.remove(this.key),t.unwatched.remove(this.key),t.removing.remove(this.key),e.put(this.key,this)},reattach:function(){var e=this.object.$session;e.removing.remove(this.key),e.unwatched.remove(this.key),e.watching.put(this.key,this),e.watch(this.object,this.relations,this.parent)},destroy:function(){var e=this.children;this.children={},this.removeListeners(),this.destroyReferences();for(var t in e)e[t].destroy()},destroyReferences:function(){var e=this.object.$session;e.watching.remove(this.key),e.removing.remove(this.key),e.unwatched.remove(this.key),this.object.$session=null,this.state=null,this.parent=null,this.save=!1,this.cascade=s},moveChildren:function(e){var t=this.children;for(var s in t)t[s].moveTo(e)}}),t.Session=i,t.SessionWatch=n,t.SessionListeners=E,t});
//# sourceMappingURL=rekord-session.min.js.map
