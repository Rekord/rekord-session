/* rekord-session 1.4.0 - Adds mass changes & discards to Rekord by Philip Diffenderfer */
!function(t,e,s){function i(){this.status=i.Status.Active,this.watching=new o,this.removing=new u,this.validationRequired=!1}function n(t,e){this.key=t,this.object=e,this.relations=!1,this.parent=!1,this.children={},this.offs=[],this.save=!1}var o=e.Map,a=e.Model,r=e.Promise,h=e.Database,u=e.Collection,c=e.ModelCollection,d=e.Relations.hasOne,l=e.Relations.belongsTo,v=e.isObject,f=e.uuid,g=e.equals,S=e.noop,$=e.addMethods,y=e.replaceMethod,m={RelationUpdate:function(t,e,s,i,n){return function(s,i){t.isDestroyed()||t.isWatching(i.lastRelated)&&!t.isWatching(t.related)&&(t.unwatch(i.lastRelated),t.watch(t.related,e.relations[n],e))}},CollectionAdd:function(t,e){return function(s,i){t.isDestroyed()||t.watch(i,e.relations,e)}},CollectionAdds:function(t,e){return function(s,i){if(!t.isDestroyed())for(var n=0;n<i.length;n++)t.watch(i[n],e.relations,e)}},CollectionRemove:function(t,e){return function(e,s){t.isDestroyed()||t.unwatch(s)}},CollectionRemoves:function(t,e){return function(e,s){if(!t.isDestroyed())for(var i=0;i<s.length;i++)t.unwatch(s[i])}},CollectionReset:function(t,e){return function(s){if(!t.isDestroyed()){e.destroyChildren();for(var i=0;i<s.length;i++)t.watch(s[i],e.relations,e)}}},CollectionCleared:function(t,e){return function(s){t.isDestroyed()||e.destroyChildren()}}};y(a.prototype,"$save",function(t){return function(s,i,n){var o=this.$session&&this.$session.isActive();return this.$isDeleted()?(e.debug(e.Debugs.SAVE_DELETED,this.$db,this),r.resolve(this)):o?(this.$set(s,i),this.$session.saveModel(this),r.resolve(this)):t.apply(this,arguments)}}),y(a.prototype,"$remove",function(t){return function(e){var s=this.$session&&this.$session.isSaving(),i=this.$session&&this.$session.isActive();return this.$exists()||s?i?(this.$session.removeModel(this),r.resolve(this)):t.apply(this,arguments):r.resolve(this)}}),i.Status={Active:"active",Saving:"saving",Disabled:"disabled",Destroyed:"destroyed"},$(i.prototype,{hasChanges:function(t){return this.removing.length>0?!0:this.searchModels(!1,function(e,s){return t&&!s.save||!e.$hasChanges()?void 0:!0})},getChanged:function(t,e){var s=e||new u;return s.push.apply(s,this.removing),this.searchModels(s,function(e,i){t&&!i.save||!e.$hasChanges()||s.push(e)})},validate:function(t){var s=!0;return e.Validation&&this.searchModels(!0,function(e,i){return e.$validate&&!e.$validate()&&(s=!1,t)?!1:void 0}),s},setValidationRequired:function(t){this.validationRequired=t},save:function(t){return this.status!==i.Status.Active?r.reject(this):this.validationRequired&&!this.validate(!t)?r.reject(this):r.singularity(r.resolve(this),this,this.handleSave)},handleSave:function(){this.status=i.Status.Saving,this.searchModels(!0,this.executeSave),this.removing.each(this.executeRemove,this),this.status=i.Status.Active},executeSave:function(t,e){e.save&&(t.$isSaved()||t.$db.models.remove(t.$key()),t.$save().success(this.afterSave(e,t)))},executeRemove:function(t){t.$status===a.Status.RemovePending&&(t.$status=a.Status.Synced,t.$db.models.put(t.$key(),t),t.$remove().success(this.afterRemove(this,t)))},afterSave:function(t,e){return function(){e.$push(),t.save=!1}},afterRemove:function(t,e){return function(){t.removing.remove(e)}},discard:function(){return this.searchModels(!0,this.discardSave),this.removing.each(this.discardRemove),this.removing.clear(),this},discardSave:function(t,e){e.save&&(t.$isSaved()?t.$pop():t.$db.removeFromModels(t),e.save=!1)},discardRemove:function(t){t.$status===a.Status.RemovePending&&(t.$pop(),t.$status=a.Status.Synced,t.$db.models.put(t.$key(),t),t.$updated())},disable:function(){this.status===i.Status.Active&&(this.status=i.Status.Disabled)},enable:function(){this.status===i.Status.Disabled&&(this.status=i.Status.Active)},isEnabled:function(){return this.status!==i.Status.Disabled&&this.status!==i.Status.Destroyed},isActive:function(){return this.status===i.Status.Active},isDisabled:function(){return this.status===i.Status.Disabled},isSaving:function(){return this.status===i.Status.Saving},isDestroyed:function(){return this.status===i.Status.Destroyed},searchModels:function(t,e,i){for(var n=i||this,o=this.watching.values,r=0;r<o.length;r++){var h=o[r];if(h.object instanceof a){var u=e.call(n,h.object,h);if(u!==s)return u}}return t},destroy:function(){if(this.status!==i.Status.Destroyed){for(var t=this.watching.values,e=0;e<t.length;e++){var s=t[e];s.parent||s.destroy(this)}this.watching.reset(),this.removing.clear(),this.status=i.Status.Destroyed}},getSessionKey:function(t,e){if(t instanceof a)return t.$uid();if(t instanceof c)return!t.$sessionKey&&e&&(t.$sessionKey=f()),t.$sessionKey;throw"The object provided cannot be watched by session."},getSessionWatch:function(t,e){var s=this.getSessionKey(t,e);if(s){var i=this.watching.get(s);return!i&&e&&(i=new n(s,t),this.watching.put(s,i)),i}},isWatching:function(t){var e=this.getSessionKey(t);return e!==!1&&this.watching.has(e)},watch:function(t,e,s){var i=this.getSessionWatch(t,!0);if(i.setRelations(e),i.setSession(this),i.setParent(s),t.$push(),v(e))for(var n in e){var o=t[n];o instanceof a?this.watch(o,e[n],i):o instanceof c&&this.watchCollection(o,e[n],i);var r=t.$getRelation(n);(r instanceof d||r instanceof l)&&i.addListener(a.Events.RelationUpdate,m.RelationUpdate(this,i,t,o,n))}return i},watchCollection:function(t,e,s){var i=this.getSessionWatch(t,!0);return i.setRelations(e),i.setSession(this),i.setParent(s),t.each(function(t){this.watch(t,e,i)},this),i.addListener(u.Events.Add,m.CollectionAdd(this,i)),i.addListener(u.Events.Adds,m.CollectionAdds(this,i)),i.addListener(u.Events.Reset,m.CollectionReset(this,i)),i.addListener(u.Events.Remove,m.CollectionRemove(this,i)),i.addListener(u.Events.Removes,m.CollectionRemoves(this,i)),i.addListener(u.Events.Cleared,m.CollectionCleared(this,i)),i},unwatch:function(t){if(t){var e=this.getSessionWatch(t);e&&e.destroy(this)}},saveModel:function(t){var e=this.getSessionWatch(t);if(e&&!e.save){var s=t.$key(),i=t.$db;i.models.has(s)?(i.trigger(h.Events.ModelUpdated,[t]),t.$trigger(a.Events.UpdateAndSave)):(i.models.put(s,t),i.trigger(h.Events.ModelAdded,[t]),i.updated(),t.$trigger(a.Events.CreateAndSave)),e.save=!0}},removeModel:function(t){var e=this.getSessionWatch(t);e&&(t.$push(),t.$status=a.Status.RemovePending,t.$db.removeFromModels(t),this.removing.add(t),e.destroy(this))}}),$(n.prototype,{setRelations:function(t){if(v(t)){if(this.relations&&!g(this.relations,t))throw"Changing already watched relations is not allowed.";this.relations=t}},setSession:function(t){var e=this.object,s=e.$session;if(s&&s!==t&&!s.isDestroyed())throw"An object can only be watched by one live session at a time.";e.$session=t},setParent:function(t){this.parent=t,t&&(t.children[this.key]=this)},addListener:function(t,e){var s=this.object,i=S;s.$on?i=s.$on(t,e):s.on&&(i=s.on(t,e)),this.offs.push(i)},destroy:function(t){for(var e=this.offs,s=this.object,i=0;i<e.length;i++)e[i]();t.watching.remove(this.key),this.destroyChildren(t),s.$session=null,this.parent=null,this.offs.length=0,this.save=!1},destroyChildren:function(t){var e=this.children;for(var s in e)e[s].destroy(t);this.children={}}}),e.Session=i,e.SessionWatch=n}(this,this.Rekord);
//# sourceMappingURL=rekord-session.min.js.map
